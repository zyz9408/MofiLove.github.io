<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>七夕限定卡池 | 聊天抽卡</title>
<style>
  :root{--bg:#0b0c10;--panel:#14161c;--ink:#e9eef4;--muted:#a8b3c7;--primary:#ff3b7b;--accent:#8a6cff;--n:#8b9bb1;--r:#3eb9ff;--sr:#7fff9f;--ssr:#ffd76a}
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 600px at 50% -50%,#1b1d25,var(--bg));color:var(--ink);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:16px 16px 96px}
  header{position:sticky;top:0;z-index:2;background:linear-gradient(180deg,rgba(11,12,16,.9),rgba(11,12,16,.35));backdrop-filter:blur(6px);padding:8px 8px;margin:-16px -16px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
  header .row{max-width:980px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:4px 8px}
  h1{font-size:18px;margin:0;font-weight:800}
  .badge{margin-left:auto;color:var(--muted);font-size:13px}
  nav{display:flex;gap:8px}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:transparent;color:var(--ink);cursor:pointer}
  .tab.active{background:rgba(255,255,255,.08)}

  .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px}
  .chat{height:60vh;min-height:380px;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:12px}

  .msg{max-width:76%;padding:10px 12px;border-radius:14px;position:relative}
  .msg .meta{font-size:12px;color:var(--muted);margin-top:6px}
  .msg .rarity{display:inline-block;margin-left:6px;padding:0 6px;border-radius:999px;font-size:11px;font-weight:800;border:1px solid currentColor}
  .left{align-self:flex-start;background:#171a24;border:1px solid rgba(255,255,255,.06)}
  .right{align-self:flex-end;background:linear-gradient(180deg,rgba(255,59,123,.18),rgba(255,255,255,.06));border:1px solid rgba(255,255,255,.12)}
  .N{color:var(--n)}.R{color:var(--r)}.SR{color:var(--sr)}.SSR{color:#222;background:var(--ssr)}

  .composer{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(11,12,16,.0),rgba(11,12,16,.9));backdrop-filter:blur(6px);padding:14px}
  .composer .inner{max-width:980px;margin:0 auto;display:flex;gap:10px}
  .send{flex:1;display:flex;align-items:center;justify-content:center;padding:14px 18px;border-radius:999px;background:var(--primary);color:#fff;font-weight:900;border:none;cursor:pointer;box-shadow:0 8px 24px rgba(255,59,123,.35)}
  .send:active{transform:translateY(1px)}
  .send.alt{background:var(--accent);box-shadow:0 8px 24px rgba(138,108,255,.35)}
  .tiny{margin-left:8px;color:var(--muted);font-size:13px}

  .controls{display:flex;gap:10px;align-items:center;margin-top:10px}
  .ghost{background:transparent;border:1px dashed rgba(255,255,255,.25);color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer}

  .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden}
  .confetti i{position:absolute;top:-10px;font-style:normal;animation:fall 2.2s linear forwards}
  @keyframes fall{to{transform:translateY(110vh) rotate(720deg);opacity:.9}}

  /* 结局动画遮罩 */
  .ending{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:1000;background:radial-gradient(1000px 600px at 50% -20%,rgba(255,255,255,.08),rgba(11,12,16,.95));backdrop-filter:blur(8px)}
  .ending.hidden{display:none}
  .ending-card{width:min(560px,92vw);padding:22px;border-radius:20px;border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));box-shadow:0 24px 60px rgba(0,0,0,.45);text-align:center}
  .ending-title{font-size:28px;font-weight:900;letter-spacing:.5px;margin:6px 0}
  .ending-sub{color:var(--muted);margin-bottom:14px}
  .ending-btn{padding:12px 18px;border:none;border-radius:999px;background:var(--primary);color:#fff;font-weight:900;cursor:pointer}
  .ending-hearts{position:relative;height:120px;overflow:hidden;margin:6px 0 12px}
  .ending-hearts i{position:absolute;bottom:-16px;animation:rise 3.4s linear infinite;opacity:.9}
  @keyframes rise{to{transform:translateY(-160px) rotate(360deg);opacity:0}}

  /* 展馆 */
  .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;padding:12px}
  .cardItem{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);display:flex;flex-direction:column;gap:6px}
  .cardItem.lock .name{color:#78839a}
  .cardItem.lock{opacity:.6}
  .badgeR{display:inline-flex;gap:6px;align-items:center;font-size:12px;color:var(--muted)}
  .desc{color:var(--muted);font-size:12px}

  /* 概率记录 */
  .statsPane{padding:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,.12);text-align:left}
  th{color:var(--muted)}

  .hidden{display:none}
</style>
</head>
<body>
  <header>
    <div class="row">
      <h1>七夕限定 · 聊天卡池</h1>
      <nav>
        <button class="tab active" data-tab="chatPane">聊天</button>
        <button class="tab" data-tab="galleryPane">结局展馆</button>
        <button class="tab" data-tab="statsPane">概率记录</button>
      </nav>
      <div class="badge" id="stats">0 抽 · SSR 0 · 完成 0/50</div>
    </div>
  </header>

  <main class="wrap">
    <section id="chatPane" class="card chat"></section>

    <section id="galleryPane" class="card hidden">
      <div class="gallery" id="gallery"></div>
      <div style="padding:10px 12px;color:var(--muted);font-size:13px">* 收集进度只在本地保存</div>
    </section>

    <section id="statsPane" class="card hidden statsPane">
      <h3 style="margin:6px 0 12px">总体概率</h3>
      <table id="rarTbl"></table>
      <h3 style="margin:16px 0 12px">单项概率</h3>
      <table id="itmTbl"></table>
    </section>

    <div class="controls">
      <button class="ghost" id="copy">复制最近 10 条</button>
      <button class="ghost" id="reset">清空记录</button>
      <span class="tiny">* 所有结果仅保存在本地</span>
    </div>
  </main>

  <div class="composer">
    <div class="inner">
      <button class="send" id="sendBtn">咱俩试试？</button>
      <button class="send alt" id="send10">十连抽</button>
    </div>
  </div>

  <div class="confetti" id="confetti" aria-hidden="true"></div>
  <!-- SSR 结局遮罩 -->
  <div class="ending hidden" id="ending">
    <div class="ending-card">
      <div class="ending-hearts" id="endingHearts"></div>
      <div class="ending-title">结局达成：真爱 ❤️</div>
      <div class="ending-sub">玩家获得了真爱（SSR）。恭喜！</div>
      <button class="ending-btn" id="continueBtn">继续游戏</button>
    </div>
  </div>

<script>
// —— 纯 ES5，无模板字符串/箭头函数/数字分隔符 ——
(function(){
  // ===== 奖池（50 条，N→SSR，带 desc） =====
  var POOL = [
    {
        "text": "你谁啊？也不照照镜子，真以为我会理你？",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "就你这德行也配发消息？赶紧滚远点，别脏了我的屏幕。"
    },
    {
        "text": "笑死，你这种人也敢来找我？心里没点数吗？",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "建议你先去整整容再学学说话，别出来丢人现眼行不行？"
    },
    {
        "text": "没空，滚。",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "你在我这儿连个屁都不算，别浪费我时间了行吗？"
    },
    {
        "text": "你发这些东西不觉得尴尬吗？我看着都替你难受。你跟叶笙似的",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "建议你找个地缝钻进去，永远别出来发这种弱智内容。"
    },
    {
        "text": "就你？也配和我说话？知道我谁不？上海少妇懒大人！",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "麻烦你有点自知之明，离我远点，越远越好，谢谢合作。"
    },
    {
        "text": "你是不是闲得慌？我没空陪你耗。",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "建议你去找个厂上班，别在这儿发些没用的东西烦我。"
    },
    {
        "text": "你这种话也好意思说出口？真是脸皮厚。",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "我要是你早就闭嘴了，你怎么还能这么自信地发消息啊？"
    },
    {
        "text": "别发了，看了就想吐。",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "你每发一条消息都是在挑战我的忍耐极限，懂吗？"
    },
    {
        "text": "你算什么玩意儿？也配让我回你？",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "建议你重新投胎学学怎么说话，这辈子估计是没戏了。"
    },
    {
        "text": "闭嘴吧你，听见你声音就烦。跟你的Kivi过去吧！奶狗！",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "你每说一句话都是在污染我的耳朵，能不能自觉点消失？"
    },
    {
        "text": "你是不是有病？病得不轻吧？让老马草草你！",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "建议你赶紧去医院看看脑子，别在这儿发癫了行不行？"
    },
    {
        "text": "你这种人也配有感情？别搞笑了。",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "我宁愿跟扫地机器人聊天也不想回你一句，明白吗？"
    },
    {
        "text": "你发的东西狗都不理。就轩陌理你！",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "连路边的野猫看了你的消息都得摇摇头走开，你品品。"
    },
    {
        "text": "你是不是觉得自己挺幽默？其实尬得我脚趾抠地。",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "你每发一条消息都是在谋杀我的脑细胞，麻烦你停手吧。"
    },
    {
        "text": "就你这样的也敢来撩我？谁给你的勇气？",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "梁静茹都不敢给你这份勇气，建议你赶紧撤回这些丢人话。"
    },
    {
        "text": "你让我觉得恶心，真的。",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "每收到你一条消息我都得洗一遍眼睛，太难受了。"
    },
    {
        "text": "别自作多情了，我看见你就烦。",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "你在我眼里就跟背景板似的，麻烦你自己有点数行不行？"
    },
    {
        "text": "你是不是没朋友才来找我？真可怜。",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "建议你先学会怎么和人正常交流，别一开口就暴露智商。"
    },
    {
        "text": "你这种话还是留给垃圾桶听吧。",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "我连标点符号都不想回你，你怎么还能这么执着啊？"
    },
    {
        "text": "你让我对人性产生了怀疑。",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "怎么能有人像你这样又蠢又自信的？真是世界之大无奇不有。"
    },
    {
        "text": "你是不是觉得自己挺可爱？其实可笑极了。",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "建议你照照镜子，然后把手机格式化，重新学学怎么做人。"
    },
    {
        "text": "你发的东西连AI都生成不出来这么尬的。",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "我要是你早就把手机砸了，免得继续丢人现眼。"
    },
    {
        "text": "你这种人也配有爱情？别做梦了。",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "我宁愿孤独终老也不想和你有半毛钱关系，懂？"
    },
    {
        "text": "你让我想起了厕所里的东西，一样让人不想靠近。",
        "prob": 2.75, // N: Increased
        "rarity": "N",
        "desc": "每当你发消息，我都觉得需要消毒一下手机屏幕。"
    },
    {
        "text": "我们真的不合适，你配不上我。",
        "prob": 2.0, // R: Increased
        "rarity": "R",
        "desc": "你和我之间差着十万八千里，建议你别白费力气了。"
    },
    {
        "text": "你这种人还是去找个差不多的吧，别来烦我。",
        "prob": 2.0, // R: Increased
        "rarity": "R",
        "desc": "我和你根本不是同一个世界的人，聊下去也是浪费彼此时间。"
    },
    {
        "text": "你先照照镜子再来说话行吗？",
        "prob": 2.0, // R: Increased
        "rarity": "R",
        "desc": "你每发一条消息都在提醒我，有些人真的缺乏自知之明。"
    },
    {
        "text": "别浪费时间了，我们不可能的。",
        "prob": 2.0, // R: Increased
        "rarity": "R",
        "desc": "你在我这儿连备选都算不上，建议你早点清醒。"
    },
    {
        "text": "你是不是对谁都这么发消息？不觉得丢人吗？",
        "prob": 2.0, // R: Increased
        "rarity": "R",
        "desc": "我要是你早就换个星球生活了，怎么还能这么坦然啊？"
    },
    {
        "text": "你让我很尴尬，真的。",
        "prob": 2.0, // R: Increased
        "rarity": "R",
        "desc": "每回你消息我都得做半天心理建设，太难受了。"
    },
    {
        "text": "我们之间连万分之一的可能性都没有。",
        "prob": 2.0, // R: Increased
        "rarity": "R",
        "desc": "你和我之间隔着一整个银河系，麻烦你别再发消息了。"
    },
    {
        "text": "你这种话还是留给喜欢你的人听吧，可惜不是我。",
        "prob": 2.0, // R: Increased
        "rarity": "R",
        "desc": "我对你没有任何兴趣，建议你早点认清现实。"
    },
    {
        "text": "你是不是没被人拒绝过？今天让你体验一下。",
        "prob": 2.0, // R: Increased
        "rarity": "R",
        "desc": "你每发一条消息都在降低你在我这儿本来就不存在的分数。"
    },
    {
        "text": "你让我觉得单身真好。",
        "prob": 2.0, // R: Increased
        "rarity": "R",
        "desc": "谢谢你让我更加珍惜现在一个人的生活，麻烦你继续保持距离。"
    },
    {
        "text": "我们之间连朋友都没得做，你明白吗？",
        "prob": 2.0, // R: Increased
        "rarity": "R",
        "desc": "你在我这儿连普通路人都算不上，建议你自觉消失。"
    },
    {
        "text": "你是不是觉得自己挺有魅力？其实毫无吸引力。",
        "prob": 2.0, // R: Increased
        "rarity": "R",
        "desc": "你每发一条消息都在证明你对自己认知有多么不清晰。"
    },
    {
        "text": "你这种性格还是先改改吧，没人受得了。",
        "prob": 2.0, // R: Increased
        "rarity": "R",
        "desc": "我要是你早就开始自我反省了，你怎么还能这么自信啊？"
    },
    {
        "text": "你让我对聊天产生了恐惧。",
        "prob": 2.0, // R: Increased
        "rarity": "R",
        "desc": "每次看到你发消息我都想卸载微信，太折磨人了。"
    },
    {
        "text": "谢谢你的喜欢，但我不需要。",
        "prob": 2.0, // R: Increased
        "rarity": "R",
        "desc": "你的心意对我来说是一种负担，麻烦你收回去。"
    },
    {
        "text": "我觉得我们还是做普通朋友比较好，真的。",
        "prob": 0.4, // SR: Decreased
        "rarity": "SR",
        "desc": "你人不错，但我们对彼此的了解还不够深入，先从朋友开始吧。"
    },
    {
        "text": "我现在还不想谈恋爱，我们先保持朋友关系好吗？",
        "prob": 0.4, // SR: Decreased
        "rarity": "SR",
        "desc": "你是个很好的人，但我现在更需要的是朋友而不是恋人。"
    },
    {
        "text": "我觉得朋友关系更适合我们，你觉得呢？",
        "prob": 0.4, // SR: Decreased
        "rarity": "SR",
        "desc": "我们可以先慢慢了解彼此，不要急着确定关系好吗？"
    },
    {
        "text": "你是个很好的朋友，我希望我们能保持现在的关系。",
        "prob": 0.4, // SR: Decreased
        "rarity": "SR",
        "desc": "我真的很珍惜我们现在的友谊，不想因为其他因素破坏它。"
    },
    {
        "text": "我觉得我们现在这样挺好的，先不要改变好吗？",
        "prob": 0.4, // SR: Decreased
        "rarity": "SR",
        "desc": "我们可以继续像现在这样做朋友，慢慢了解彼此。"
    },
    {
        "text": "我暂时还不想谈恋爱，但我们还可以做朋友。",
        "prob": 0.4, // SR: Decreased
        "rarity": "SR",
        "desc": "你是个很特别的人，但我现在更需要的是朋友的陪伴。"
    },
    {
        "text": "我觉得朋友之间相处更轻松，我们先保持这样好吗？",
        "prob": 0.4, // SR: Decreased
        "rarity": "SR",
        "desc": "我们可以先做朋友，给彼此一些时间和空间来了解对方。"
    },
    {
        "text": "你是个很好的人，但我觉得我们更适合做朋友。",
        "prob": 0.4, // SR: Decreased
        "rarity": "SR",
        "desc": "我真的很珍惜你这个朋友，不希望我们的关系变得复杂。"
    },
    {
        "text": "我觉得我们现在这样做朋友挺好的，你觉得呢？",
        "prob": 0.4, // SR: Decreased
        "rarity": "SR",
        "desc": "我们可以继续保持朋友关系，给彼此更多时间了解。"
    },
    {
        "text": "我暂时还不想改变我们之间的关系，先做朋友好吗？",
        "prob": 0.4, // SR: Decreased
        "rarity": "SR",
        "desc": "你是个很特别的人，但我希望我们能先从朋友开始。"
    },
    {
        "text": "好呀宝贝，我也喜欢你很久了！但是我更爱莫非,对不起了！",
        "prob": 0.1, // SSR: Extremely Rare
        "rarity": "SSR",
        "desc": "没人不爱莫非,对吧？"
    }
  ];

  // —— 概率累计 ——
  var million = 1000000;
  var weights = []; var total = 0; var i;
  for(i=0;i<POOL.length;i++){ var w = Math.round(POOL[i].prob/100 * million); weights.push(w); total += w; }
  var cumulative = []; for(i=0;i<weights.length;i++){ cumulative.push( (cumulative.length? cumulative[cumulative.length-1] : 0) + weights[i] ); }

  // —— 全局状态 ——
  var draws = []; var chat = [];

  // —— DOM refs ——
  var panes, chatEl, galleryEl, rarTbl, itmTbl, statsEl, sendBtn, send10Btn, copyBtn, resetBtn;

  function loadState(){
    try{ draws = JSON.parse(localStorage.getItem('xixi-gacha-record')||'[]'); }catch(e){ draws=[]; }
    try{ chat = JSON.parse(localStorage.getItem('xixi-gacha-chat')||'[]'); }catch(e){ chat=[]; }
  }
  function saveState(){
    localStorage.setItem('xixi-gacha-record', JSON.stringify(draws));
    localStorage.setItem('xixi-gacha-chat', JSON.stringify(chat));
  }

  function switchTab(id){
    var tabs = document.querySelectorAll('.tab');
    for(i=0;i<tabs.length;i++){ tabs[i].classList.toggle('active', tabs[i].getAttribute('data-tab')===id); }
    var keys=['chatPane','galleryPane','statsPane'];
    for(i=0;i<keys.length;i++){ panes[keys[i]].classList.toggle('hidden', keys[i]!==id); }
    if(id==='galleryPane') renderGallery();
    if(id==='statsPane') renderStatsTables();
  }

  function getUnlockedMap(){ var map = {}; for(i=0;i<draws.length;i++){ map[draws[i].index]=1; } return map; }
  function unlockedCount(){ var m=getUnlockedMap(); var c=0; for(var k in m){ if(m.hasOwnProperty(k)) c++; } return c; }

  function renderTopStats(){
    var cnt = draws.length; var ssr = 0; for(i=0;i<draws.length;i++){ if(draws[i].rarity==='SSR') ssr++; }
    statsEl.textContent = cnt + ' 抽 · SSR ' + ssr + ' · 完成 ' + unlockedCount() + '/' + POOL.length;
  }

  function bubble(side, html){ var d = document.createElement('div'); d.className = 'msg ' + (side==='user'?'right':'left'); d.innerHTML = html; chatEl.appendChild(d); chatEl.scrollTop = chatEl.scrollHeight; }
  function renderChat(){
    chatEl.innerHTML='';
    if(chat.length===0){ chat.push({side:'left', html:'<div>🎋 活动开启：点击下方“<b>咱俩试试？</b>”来抽卡</div><div class="meta">截止 2025-08-29 · 概率记录与收集均保存本地</div>'}); }
    for(i=0;i<chat.length;i++){ bubble(chat[i].side, chat[i].html); }
  }

  function pickOne(){ var r = Math.floor(Math.random()*total); var idx=-1; for(i=0;i<cumulative.length;i++){ if(r < cumulative[i]){ idx=i; break; } } var it = POOL[idx]; return { index: idx, text: it.text, prob: it.prob, rarity: it.rarity }; }

  function confetti(){ var holder=document.getElementById('confetti'); holder.innerHTML=''; var icons=['🎉','✨','💫','⭐️']; for(i=0;i<80;i++){ var el=document.createElement('i'); el.textContent=icons[Math.floor(Math.random()*icons.length)]; el.style.left=(Math.random()*100)+'vw'; el.style.fontSize=(12+Math.random()*24)+'px'; el.style.animationDelay=(Math.random()*0.6)+'s'; holder.appendChild(el);} setTimeout(function(){ holder.innerHTML=''; }, 2600); }

  // —— SSR 结局动画 ——
  function showEnding(){ var o=document.getElementById('ending'); var box=document.getElementById('endingHearts'); box.innerHTML=''; var emo=['💖','💘','💞','✨']; for(var j=0;j<36;j++){ var sp=document.createElement('i'); sp.textContent=emo[Math.floor(Math.random()*emo.length)]; sp.style.left=(Math.random()*100)+'%'; sp.style.fontSize=(14+Math.random()*28)+'px'; sp.style.animationDelay=(Math.random()*1.2)+'s'; box.appendChild(sp);} o.className='ending'; }
  function hideEnding(){ var o=document.getElementById('ending'); o.className='ending hidden'; }

  function renderGallery(){
    var un = getUnlockedMap(); galleryEl.innerHTML='';
    var wrap = document.createElement('div'); wrap.className='cardItem'; wrap.innerHTML = '<div class="badgeR">收集进度 <span id="progTxt"></span></div><div class="progress"><i id="progBar"></i></div>'; galleryEl.appendChild(wrap);
    for(i=0;i<POOL.length;i++){
      var p=POOL[i]; var card=document.createElement('div'); var got=un[i]===1; card.className='cardItem'+(got?'':' lock');
      var desc = p.desc ? p.desc : '';
      card.innerHTML = '<div class="name">'+p.text+'</div>'+
                       '<div class="desc">'+desc+'</div>'+
                       '<div class="badgeR">稀有度 <span class="rarity '+p.rarity+'">'+p.rarity+'</span></div>'+
                       '<div class="badgeR">期望：'+p.prob+'%</div>';
      galleryEl.appendChild(card);
    }
    var have = unlockedCount(); var prog = Math.round(have/POOL.length*100)+'%'; document.getElementById('progTxt').textContent = have+'/'+POOL.length+' · '+prog; document.getElementById('progBar').style.width = prog;
  }

  function renderStatsTables(){
    var rarities=['N','R','SR','SSR']; var rhtml='<tr><th>稀有度</th><th>条目数</th><th>期望概率</th><th>命中次数</th><th>观察概率</th></tr>';
    for(var ri=0;ri<rarities.length;ri++){
      var r = rarities[ri]; var count=0, expect=0, hits=0; for(i=0;i<POOL.length;i++){ if(POOL[i].rarity===r){ count++; expect+=POOL[i].prob; } }
      for(i=0;i<draws.length;i++){ if(draws[i].rarity===r) hits++; }
      var rate = draws.length? (hits/draws.length*100):0; rhtml += '<tr><td>'+r+'</td><td>'+count+'</td><td>'+expect.toFixed(2)+'%</td><td>'+hits+'</td><td>'+rate.toFixed(2)+'%</td></tr>';
    }
    rarTbl.innerHTML = rhtml + (draws.length?'<tr><td colspan="5" style="color:var(--muted)">总抽数：'+draws.length+'</td></tr>':'');

    var map={}; for(i=0;i<draws.length;i++){ map[draws[i].index]=(map[draws[i].index]||0)+1; }
    var ihtml='<tr><th>#</th><th>结果</th><th>稀有度</th><th>期望概率</th><th>命中次数</th><th>观察概率</th></tr>';
    for(i=0;i<POOL.length;i++){ var p=POOL[i]; var hit = map[i]||0; var rate2 = draws.length? (hit/draws.length*100):0; ihtml += '<tr><td>'+(i+1)+'</td><td>'+p.text+'</td><td><span class="rarity '+p.rarity+'">'+p.rarity+'</span></td><td>'+p.prob+'%</td><td>'+hit+'</td><td>'+rate2.toFixed(2)+'%</td></tr>'; }
    itmTbl.innerHTML = ihtml;
  }

  function init(){
    panes={ chatPane: document.getElementById('chatPane'), galleryPane: document.getElementById('galleryPane'), statsPane: document.getElementById('statsPane') };
    chatEl = panes.chatPane; galleryEl=document.getElementById('gallery'); rarTbl=document.getElementById('rarTbl'); itmTbl=document.getElementById('itmTbl'); statsEl=document.getElementById('stats');
    sendBtn=document.getElementById('sendBtn'); send10Btn=document.getElementById('send10'); copyBtn=document.getElementById('copy'); resetBtn=document.getElementById('reset');

    loadState();

    var tabs = document.querySelectorAll('.tab'); for(i=0;i<tabs.length;i++){ (function(btn){ btn.addEventListener('click', function(){ switchTab(btn.getAttribute('data-tab')); }); })(tabs[i]); }

    renderChat(); renderTopStats(); renderGallery(); renderStatsTables();

    var busy=false; var cont=document.getElementById('continueBtn'); if(cont){ cont.addEventListener('click', function(){ hideEnding(); }); }

    if(sendBtn){
      sendBtn.addEventListener('click', function(){
        if(busy) return; busy=true; sendBtn.disabled=true; if(send10Btn) send10Btn.disabled=true;
        var userHtml = '<div>我：<b>咱俩试试？</b></div>'; chat.push({side:'user', html:userHtml}); bubble('user', userHtml);
        setTimeout(function(){ var item=pickOne(); var tag='<span class="rarity '+item.rarity+'">'+item.rarity+'</span>'; var botHtml = '<div>'+item.text+' '+tag+'</div>'; chat.push({side:'left', html:botHtml}); bubble('left', botHtml); draws.push({ id:draws.length+1, index:item.index, text:item.text, rarity:item.rarity }); if(draws.length>2000) draws=draws.slice(-2000); saveState(); renderTopStats(); if(item.rarity==='SSR'){ confetti(); showEnding(); } sendBtn.disabled=false; if(send10Btn) send10Btn.disabled=false; busy=false; }, 360);
      });
    }

    // 十连抽事件
    if(send10Btn){
      send10Btn.addEventListener('click', function(){
        if(busy) return; busy=true; if(sendBtn) sendBtn.disabled=true; send10Btn.disabled=true;
        var userHtml = '<div>我：<b>十连抽（×10）</b></div>'; chat.push({side:'user', html:userHtml}); bubble('user', userHtml);
        setTimeout(function(){
          var anySSR=false; var list='';
          for(var k=0;k<10;k++){
            var it=pickOne();
            var tag='<span class="rarity '+it.rarity+'">'+it.rarity+'</span>';
            list += '<div>• '+it.text+' '+tag+'</div>';
            draws.push({ id:draws.length+1, index:it.index, text:it.text, rarity:it.rarity });
            if(it.rarity==='SSR') anySSR=true;
          }
          saveState(); renderTopStats(); bubble('left','<div>十连结果：</div>'+list);
          if(anySSR){ confetti(); showEnding(); }
          if(sendBtn) sendBtn.disabled=false; send10Btn.disabled=false; busy=false;
        }, 360);
      });
    }

    if(copyBtn){
      copyBtn.addEventListener('click', function(){
        var last10='';
        var start = Math.max(0, draws.length-10);
        for(i=start;i<draws.length;i++){
          last10 += '['+draws[i].rarity+'] '+draws[i].text + (i<draws.length-1 ? '\n' : '');
        }
        var text = '最近 10 次回复：\n' + (last10 || '（暂无记录）');
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(text).then(function(){
            bubble('left','<div>✅ 已复制最近 10 条结果</div>');
          }, function(){
            bubble('left','<div>❗️ 复制失败（权限），已输出到控制台</div>');
            console.log(text);
          });
        } else {
          try{
            var ta=document.createElement('textarea');
            ta.value=text; document.body.appendChild(ta); ta.select();
            document.execCommand('copy'); document.body.removeChild(ta);
            bubble('left','<div>✅ 已复制最近 10 条结果</div>');
          } catch(e){
            bubble('left','<div>❗️ 复制失败（环境受限），已输出到控制台</div>');
            console.log(text);
          }
        }
      });
    }

    if(resetBtn){
      resetBtn.addEventListener('click', function(){
        if(!confirm('清空所有对话与记录？')) return;
        draws=[]; chat=[]; saveState(); renderChat(); renderTopStats(); renderGallery(); renderStatsTables();
        bubble('left','<div>记录已清空。点击“<b>咱俩试试？</b>”重新开始。</div>');
      });
    }
  }

  if(document.readyState==='loading'){ window.addEventListener('DOMContentLoaded', init); } else { init(); }
})();
</script>
</body>
</html>